#pragma once

#include <stdlib.h>
#include <string.h>
#include <sys/types.h>

/**
 * Assuming the following strings are never present within the combined string
 * containing payload size, payload and payload checksum:
 *
 *     "+="
 *     "=+"
 *     "#@"
 *     "@#"
 *     "!%"
 *     "%!"
 *     "?^"
 *     "^?"
 *
 *  8-character markers:
 *
 *     "+=+=+=+=123#@#@#@#@"          lmcpObjPayloadSize
 *     "#@#@#@#@abcxyz123!%!%!%!%"    rawPayload
 *     "!%!%!%!%789?^?^?^?^"          lmcpObjPayloadChksum
 *     "+=+=+=+=123#@#@#@#@abcxyz123!%!%!%!%789?^?^?^?^" lmcpObjPayloadSize, rawPayload and lmcpObjPayloadChksum (combined int
 */


#define SENTINEL_SERIAL_BUFFER_RING_SIZE (x10000)


typedef struct sentinel_serial_buffer {
  /**
   * multi-thread safety not implemented
   * @param data
   * @return 
   */
  uint8_t data[SENTINEL_SERIAL_BUFFER_RING_SIZE];
  size_t write_offset;
  size_t read_offset;
  uint32_t valid_deserialize_count;
  uint32_t invalid_deserialize_count;
  uint32_t disregarded_data_count;
} sentinel_serial_buffer_t;


struct sentinel_serial_buffer *sentinel_serial_buffer_alloc();


void sentinel_serial_buffer_free(struct sentinel_serial_buffer *ctx);



    /**
     * Supports strings containing only ascii characters
     * @param str
     * @return 
     */
    static uint32_t
    calculateChecksum(const std::string& str);
    
    static std::string
    createSentinelizedString(const std::string& data);

    static std::unique_ptr<std::string>
    getDetectSentinelBaseStringsMessage(const std::string& data);

    /**
     * multi-thread safety not implemented
     * @param data
     * @return 
     */
    std::string
    getNextPayloadString(const std::string& newDataChunk);
    
    std::string m_data;
    uint32_t m_validDeserializeCount{0};
    uint32_t m_invalidDeserializeCount{0};
    uint32_t m_disregardedDataCount{0};
