/*
 * Copyright 2020, Collins Aerospace
 */

#include <camkes.h>
#include <stdio.h>
#include <string.h>
#include <sel4/sel4.h>
#include <stdlib.h>
#include <counter.h>
#include <data.h>
#include <queue.h>

void done_emit_underlying(void) WEAK;
static void done_emit(void) {
  /* If the interface is not connected, the 'underlying' function will
   * not exist.
   */
  if (done_emit_underlying) {
    done_emit_underlying();
  }
}


//------------------------------------------------------------------------------
// Implementation of AADL Input Event Data Port (out) named "p1_out"
//
// NOTE: If we only need polling style receivers, we can get rid of the SendEvent

// Assumption: only one thread is calling this and/or reading p1_in_recv_counter.
void p1_out_aadl_event_data_send(data_t *data) {
    queue_enqueue(p1_out_queue, data);
    p1_out_SendEvent_emit();
    done_emit();
}

//------------------------------------------------------------------------------
// Testing

void post_init(void) {
    printf("%s: post init queue\n", get_instance_name());
    queue_init(p1_out_queue);
}

static const char message[] = {
#define AIR_VEHICLE_STATE_MESSAGE
#ifdef AIR_VEHICLE_STATE_MESSAGE
0x61,0x66,0x72,0x6C,0x2E,0x63,0x6D,0x61,0x73,0x69,0x2E,0x41,0x69,0x72,0x56,0x65,
0x68,0x69,0x63,0x6C,0x65,0x53,0x74,0x61,0x74,0x65,0x24,0x6C,0x6D,0x63,0x70,0x7C,
0x61,0x66,0x72,0x6C,0x2E,0x63,0x6D,0x61,0x73,0x69,0x2E,0x41,0x69,0x72,0x56,0x65,
0x68,0x69,0x63,0x6C,0x65,0x53,0x74,0x61,0x74,0x65,0x7C,0x54,0x63,0x70,0x42,0x72,
0x69,0x64,0x67,0x65,0x7C,0x34,0x30,0x30,0x7C,0x36,0x38,0x24,0x4C,0x4D,0x43,0x50,
0x00,0x00,0x01,0xCF,0x01,0x43,0x4D,0x41,0x53,0x49,0x00,0x00,0x00,0x00,0x00,0x00,
0x0F,0x00,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x90,0x41,0xB0,0xD6,0x2D,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x43,0x0A,0xF8,0x22,0x00,0x00,0x00,0x00,0x41,0x9F,0xFF,0x72,0x37,
0x18,0xF3,0x2C,0x41,0x66,0x0F,0x2B,0x42,0x1E,0x05,0xE2,0x43,0x0A,0xF8,0x22,0x41,
0xB0,0xDD,0x90,0x01,0x43,0x4D,0x41,0x53,0x49,0x00,0x00,0x00,0x00,0x00,0x00,0x03,
0x00,0x03,0x40,0x46,0xA8,0x88,0xD3,0xEE,0xDB,0xEA,0xC0,0x5E,0x3F,0x6B,0x3D,0xA6,
0x0C,0x11,0x44,0x2F,0x00,0x00,0x00,0x00,0x00,0x01,0x42,0xC7,0xFF,0x2F,0x39,0x91,
0xC0,0x87,0x00,0x02,0x01,0x43,0x4D,0x41,0x53,0x49,0x00,0x00,0x00,0x00,0x00,0x00,
0x1B,0x00,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,
0x01,0x00,0x00,0x00,0x00,0xC2,0x70,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x43,0x4D,
0x41,0x53,0x49,0x00,0x00,0x00,0x00,0x00,0x00,0x15,0x00,0x03,0x00,0x00,0x00,0x00,
0x00,0x00,0x27,0x11,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0xC2,0x70,
0x00,0x00,0x00,0x00,0x00,0x00,0x42,0x34,0x00,0x00,0x42,0x07,0x00,0x00,0x00,0x04,
0x01,0x43,0x4D,0x41,0x53,0x49,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x00,0x03,0x40,
0x46,0xA8,0x4A,0xCA,0xB8,0x59,0xE5,0xC0,0x5E,0x3E,0x5C,0x82,0xF5,0xCD,0x81,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x01,0x43,0x4D,0x41,0x53,0x49,0x00,0x00,0x00,
0x00,0x00,0x00,0x03,0x00,0x03,0x40,0x46,0xA7,0xDE,0xE2,0x2E,0x07,0x46,0xC0,0x5E,
0x3F,0x24,0xB4,0xA1,0x86,0xCD,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x01,0x43,
0x4D,0x41,0x53,0x49,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x00,0x03,0x40,0x46,0xA8,
0x62,0x2A,0x06,0xD4,0x4E,0xC0,0x5E,0x3F,0x5A,0x99,0x2C,0xFD,0x21,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x01,0x01,0x43,0x4D,0x41,0x53,0x49,0x00,0x00,0x00,0x00,0x00,
0x00,0x03,0x00,0x03,0x40,0x46,0xA8,0xD5,0xF9,0x47,0xF4,0xF9,0xC0,0x5E,0x3E,0xEB,
0x32,0x6B,0x8C,0x90,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x01,0x43,0x4D,0x41,
0x53,0x49,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x00,0x03,0x40,0x46,0xA8,0x5A,0x8D,
0xC5,0x49,0xE7,0xC0,0x5E,0x3F,0x07,0xEC,0x63,0x92,0xC8,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x46,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x16,
0x89,0x00,0x00,0x41,0xB0,0xD6,0x2D,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x57,0xEC
#else
0x61,0x66,0x72,0x6C,0x2E,0x63,0x6D,0x61,0x73,0x69,0x2E,0x4F,0x70,0x65,0x72,0x61,  /* afrl:cmasi:Opera */
0x74,0x69,0x6E,0x67,0x52,0x65,0x67,0x69,0x6F,0x6E,0x24,0x6C,0x6D,0x63,0x70,0x7C,  /* tingRegion$lmcp| */
0x61,0x66,0x72,0x6C,0x2E,0x63,0x6D,0x61,0x73,0x69,0x2E,0x4F,0x70,0x65,0x72,0x61,  /* afrl:cmasi:Opera */
0x74,0x69,0x6E,0x67,0x52,0x65,0x67,0x69,0x6F,0x6E,0x7C,0x54,0x63,0x70,0x42,0x72,  /* tingRegion|6?p*r */
0x69,0x64,0x67,0x65,0x7C,0x34,0x30,0x30,0x7C,0x36,0x38,0x24,0x4C,0x4D,0x43,0x50,  /* idge|400|68$LMCP */
0x00,0x00,0x00,0x2B,0x01,0x43,0x4D,0x41,0x53,0x49,0x00,0x00,0x00,0x00,0x00,0x00,  /* ...+.CMASI...... */
0x27,0x00,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x50,0x00,0x01,0x00,0x00,0x00,  /* '.........P..... */
0x00,0x00,0x00,0x01,0x4E,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x4F,0x00,  /* ....N.........O. */
0x00,0x03,0xE1                                                                    /* ...              */
#endif
};

int run(void) {

    int i = 0;
    int err = 0;
    data_t data;

    while (1) {

        // Busy loop to slow things down
        for(unsigned int j = 0; j < 10000000; ++j){
            seL4_Yield();
        }

        // Stage data
        memcpy((void *) &data.payload[0], (const void *) &message[0], sizeof(message));
        printf("%s: sending: %d\n", get_instance_name(), sizeof(message));

        // Send the data
        p1_out_aadl_event_data_send(&data);          
    }
}



